(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.metrochart=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";var metrochart_1=require("./metrochart");exports.MetroChart=metrochart_1.MetroChart;var metrocharterror_1=require("./metrocharterror");exports.MetroChartError=metrocharterror_1.MetroChartError},{"./metrochart":2,"./metrocharterror":3}],2:[function(require,module,exports){(function(global){"use strict";var metrocharterror_1=require("./metrocharterror");typeof window!=="undefined"?window["d3"]:typeof global!=="undefined"?global["d3"]:null;var MetroChart=function(){function MetroChart(elem,url,options){this.elem=elem;this._url=url;this.elemid=document.getElementById(this.elem);this.updateWidthHeight();if(typeof options==="undefined"){this.applyDefaultOptions(MetroChart.defaultOptions)}else{this.applyDefaultOptions(options)}this.loaddata();var that=this;window.addEventListener("resize",function(){that.onResize()})}MetroChart.prototype.draw=function(){this.updateWidthHeight();this.calcUniqueLines();this.verifyData();this.drawForceDirectedGraph()};MetroChart.prototype.applyDefaultOptions=function(options){var colors;colors=[];if(typeof options.colors==="undefined"){for(var _i=0,_a=MetroChart.defaultOptions.colors;_i<_a.length;_i++){var color=_a[_i];colors.push(color.hexcode)}}else{for(var _b=0,_c=options.colors;_b<_c.length;_b++){var color=_c[_b];colors.push(color.hexcode)}}this.colors=colors;if(typeof options.charge==="undefined"){this.charge=MetroChart.defaultOptions.charge}else{this.charge=options.charge}if(typeof options.gravity==="undefined"){this.gravity=MetroChart.defaultOptions.gravity}else{this.gravity=options.gravity}if(typeof options.linkDistance==="undefined"){this.linkDistance=MetroChart.defaultOptions.linkDistance}else{this.linkDistance=options.linkDistance}if(typeof options.linkStrength==="undefined"){this.linkStrength=MetroChart.defaultOptions.linkStrength}else{this.linkStrength=options.linkStrength}if(typeof options.enableTimeAxis==="undefined"){this.enableTimeAxis=MetroChart.defaultOptions.enableTimeAxis}else{this.enableTimeAxis=options.enableTimeAxis}if(typeof options.stationShapeRadius==="undefined"){this.stationShapeRadius=MetroChart.defaultOptions.stationShapeRadius}else{this.stationShapeRadius=options.stationShapeRadius}if(typeof options.labelSpaceVert==="undefined"){this.labelSpaceVert=MetroChart.defaultOptions.labelSpaceVert}else{this.labelSpaceVert=options.labelSpaceVert}if(typeof options.labelRotation==="undefined"){this.labelRotation=MetroChart.defaultOptions.labelRotation}else{this.labelRotation=options.labelRotation}if(typeof options.padding==="undefined"){this.padding=MetroChart.defaultOptions.padding}else{this.padding=options.padding}return this};MetroChart.prototype.calcLinkShape=function(link){var str="";if(typeof link.source==="object"){var xf=link.source.x;var yf=link.source.y+this.calcStubOffset(link,"source");str+="M"+xf+","+yf+" "}else{str+="M0,0 "}if(typeof link.target==="object"){var xt=link.target.x;var yt=link.target.y+this.calcStubOffset(link,"target");str+="L"+xt+","+yt}else{str+="L10,10"}return str};MetroChart.prototype.calcLabelTopOrBottom=function(station){var yTop=0+this.labelSpaceVert;var yBottom=this.h-this.labelSpaceVert;var distToTop=station.y-yTop;var distToBottom=yBottom-station.y;if(distToTop<distToBottom){return"top"}else{return"bottom"}};MetroChart.prototype.calcLabelTranslate=function(station){var yTop=0+this.labelSpaceVert;var yBottom=this.h-this.labelSpaceVert;station=this.observeBoundingBox(station);var topOrBottom=this.calcLabelTopOrBottom(station);if(topOrBottom==="top"){return"translate("+station.x+","+(yTop-10-15)+") rotate("+this.labelRotation+")"}else if(topOrBottom==="bottom"){return"translate("+station.x+","+(yBottom+10+15)+") rotate("+this.labelRotation+")"}else{throw new metrocharterror_1.MetroChartError("This should not happen.")}};MetroChart.prototype.calcStationShape=function(node){var calcStationShapeArc=function(fromy,r,topOrBottomStr){var iSection;var nSections;var outputStr;var angle;var dx;var dy;nSections=8;outputStr="";if(topOrBottomStr==="top"){for(iSection=0;iSection<=nSections;iSection+=1){angle=(nSections-iSection)/nSections*Math.PI;dx=Math.cos(angle)*r;dy=Math.sin(angle)*-r;outputStr+="L "+dx+" "+(fromy+dy)+" "}return outputStr}else if(topOrBottomStr==="bottom"){for(iSection=0;iSection<nSections;iSection+=1){angle=iSection/nSections*Math.PI;dx=Math.cos(angle)*r;dy=Math.sin(angle)*r;outputStr+="L "+dx+" "+(fromy+dy)+" "}return outputStr}else{throw new metrocharterror_1.MetroChartError(" in .calcStationShapeArc(): 'Fourth argument should be either 'top' or 'bottom'.'")}};var hw=this.stationShapeRadius;var hh=node.nLines*this.stationShapeRadius;var str="M "+-hw+" 0 "+"L "+-hw+" "+(node.nLines-1)*-this.stationShapeRadius+" "+calcStationShapeArc((node.nLines-1)*-this.stationShapeRadius,this.stationShapeRadius,"top")+"L "+ +hw+" "+(node.nLines-1)*this.stationShapeRadius+" "+calcStationShapeArc((node.nLines-1)*this.stationShapeRadius,this.stationShapeRadius,"bottom")+"L "+-hw+" "+(node.nLines-1)*this.stationShapeRadius+" "+"Z";return str};MetroChart.prototype.calcStationTranslate=function(node){if(typeof node.time==="number"&&this.enableTimeAxis===true){var f=(node.time-this.timeValueLeft)/(this.timeValueRight-this.timeValueLeft);node.x=this.padding.left+f*(this.w-this.padding.right-this.padding.left)}node=this.observeBoundingBox(node);return"translate("+node.x+","+node.y+")"};MetroChart.prototype.calcStubOffset=function(link,sourceOrTargetStr){var stubIndex;var stubOffset;var nLines;if(sourceOrTargetStr==="source"){var linesAtSource=this.nodes[link.source.index].lines;nLines=linesAtSource.length;stubIndex=linesAtSource.indexOf(link.line)}else if(sourceOrTargetStr==="target"){var linesAtTarget=this.nodes[link.target.index].lines;nLines=linesAtTarget.length;stubIndex=linesAtTarget.indexOf(link.line)}else{throw new metrocharterror_1.MetroChartError(" in .calcStubOffset(): 'Input argument sh"+"ould be 'source' or 'target' .'")}stubOffset=-1*(nLines*this.stationShapeRadius-this.stationShapeRadius)+stubIndex*2*this.stationShapeRadius;return stubOffset};MetroChart.prototype.calcUniqueLines=function(){this.ulinks=[];for(var _i=0,_a=this.links;_i<_a.length;_i++){var link=_a[_i];if(this.ulinks.indexOf(link.line)===-1){this.ulinks.push(link.line)}}this.ulinks.sort();for(var _b=0,_c=this.links;_b<_c.length;_b++){var link=_c[_b];link.uindex=this.ulinks.indexOf(link.line)}};MetroChart.prototype.calcVerticalLine=function(station){var h=this.labelSpaceVert;var yTop=0+h;var yBottom=this.h-h;var distToTop=station.y-yTop;var distToBottom=yBottom-station.y;station=this.observeBoundingBox(station);var halfStationHeight=station.nLines*this.stationShapeRadius;var buffer=30;if(distToTop<distToBottom){return"M "+station.x+" "+(station.y-halfStationHeight-5)+" "+"L "+station.x+","+(yTop-buffer+15)}else{return"M "+station.x+" "+(station.y+halfStationHeight+5)+" "+"L "+station.x+","+(yBottom+buffer-15)}};MetroChart.prototype.drawForceDirectedGraph=function(){var onMouseOutNodeGroup=function(eventsource){var children=d3.select(eventsource).selectAll(".nodegroup-child");children.classed("highlight",false)};var onMouseOverNodeGroup=function(eventsource){var children=d3.select(eventsource).selectAll(".nodegroup-child");children.classed("highlight",true);d3.selectAll(".nodegroup-parent").each(function(){if(this===eventsource){this.parentNode.appendChild(this)}})};var onMouseOutMetroLine=function(eventsource){var uindex=d3.select(eventsource).datum().uindex;var classname=".link.line"+uindex;d3.selectAll(classname).classed("highlight",false)};var onMouseOverMetroLine=function(eventsource){var uindex=d3.select(eventsource).datum().uindex;var classname=".link.line"+uindex;d3.selectAll(classname).classed("highlight",true)};var that=this;var vis=d3.select(this.elemid).append("svg").attr("width",this.w).attr("height",this.h);var force=d3.layout.force().size([this.w,this.h]).nodes(this.nodes).links(this.links);force.charge(this.charge);force.gravity(this.gravity);force.linkDistance(this.linkDistance);force.linkStrength(this.linkStrength);var link=vis.selectAll(".link").data(this.links).enter().append("path").attr("class",function(d){return"link"+" "+"line"+d.uindex}).attr("d",function(d){return that.calcLinkShape(d)}).style("stroke",function(d){return that.getColor(d.uindex)}).on("click",function(d){console.log(that.linelabel+" "+d.line)}).on("mouseover",function(){var eventsource=this;onMouseOverMetroLine(eventsource)}).on("mouseout",function(){var eventsource=this;onMouseOutMetroLine(eventsource)});var nodeGroup=vis.selectAll(".node").data(this.nodes).enter().append("g").attr("class","nodegroup-parent").on("mouseover",function(){var eventsource=this;onMouseOverNodeGroup(eventsource)}).on("mouseout",function(){var eventsource=this;onMouseOutNodeGroup(eventsource)});var label=nodeGroup.append("text").attr("class","label nodegroup-child").attr("transform","translate(0,0) rotate(45)").text(function(d){return d.name});var vline=nodeGroup.append("path").attr("class","vline nodegroup-child").attr("d",function(d){return that.calcVerticalLine(d)});var node=nodeGroup.append("path").attr("class","node nodegroup-child").attr("d",function(d){return that.calcStationShape(d)}).on("click",function(d){console.log(that.stationlabel+" "+d.index+": "+d.name)}).call(force.drag);force.on("tick",function(e){node.attr("transform",function(d){return that.calcStationTranslate(d)});label.attr("transform",function(d){return that.calcLabelTranslate(d)}).style("text-anchor",function(d){var topOrBottom=that.calcLabelTopOrBottom(d);if(topOrBottom==="top"){return"start"}else if(topOrBottom==="bottom"){return"end"}else{throw new metrocharterror_1.MetroChartError("This should not happen.")}});vline.attr("d",function(d){return that.calcVerticalLine(d)});link.attr("d",function(d){return that.calcLinkShape(d)})});force.start();return this};MetroChart.prototype.onResize=function(){var div=this.elemid;while(div.firstChild){div.removeChild(div.firstChild)}this.draw()};MetroChart.prototype.getColor=function(uindex){var str;if(typeof this.colors==="undefined"||this.colors.length===0){str="#808080"}else{var nColors=this.colors.length;str=this.colors[uindex%nColors]}return str};MetroChart.prototype.loaddata=function(){var that=this;var xmlHttp=new XMLHttpRequest;xmlHttp.onreadystatechange=function(){if(xmlHttp.status===429){console.log('Throttle limit exceeded. See "https://dev.socrata.com/docs/'+'app-tokens.html#throttling-limits" for more information.')}if(xmlHttp.readyState===4&&xmlHttp.status===200){var data=JSON.parse(xmlHttp.responseText);that.nodes=data.nodes;that.links=data.links;if(typeof data.linelabel==="undefined"){that.linelabel="line"}else{that.linelabel=data.linelabel}if(typeof data.stationlabel==="undefined"){that.stationlabel="station"}else{that.stationlabel=data.stationlabel}if(typeof data.source==="undefined"){that.datasource="unknown"}else{that.datasource=data.source}console.log("MetroChart: 'Done loading data from \""+that._url+"\"'");that.draw()}};xmlHttp.open("GET",this._url,true);xmlHttp.send(null)};MetroChart.prototype.observeBoundingBox=function(node){var hw=this.stationShapeRadius;var hh=node.nLines*this.stationShapeRadius;if(node.x>this.w-hw-this.padding.right){node.x=this.w-hw-this.padding.right}if(node.x<0+hw+this.padding.left){node.x=0+hw+this.padding.left}if(node.y>this.h-hh-this.labelSpaceVert){node.y=this.h-hh-this.labelSpaceVert}if(node.y<0+hh+this.labelSpaceVert){node.y=0+hh+this.labelSpaceVert}return node};MetroChart.prototype.verifyData=function(){for(var _i=0,_a=this.nodes;_i<_a.length;_i++){var node=_a[_i];node.x=this.w/2;node.y=this.h/2;node.nLines=node.lines.length;if(typeof node.time==="undefined"){console.log("MetroChart: 'No time information.'")}else if(typeof node.time==="number"){if(node.time<this.timeValueLeft||typeof this.timeValueLeft==="undefined"){this.timeValueLeft=node.time}if(node.time>this.timeValueRight||typeof this.timeValueRight==="undefined"){this.timeValueRight=node.time}}else{throw new metrocharterror_1.MetroChartError(" in .verifyData(): 'node.time's type should be 'number'.")}}return this};MetroChart.prototype.updateWidthHeight=function(){this.w=this.elemid.getBoundingClientRect().width;this.h=this.elemid.getBoundingClientRect().height};Object.defineProperty(MetroChart.prototype,"colors",{get:function(){return this._colors},set:function(colors){this._colors=colors},enumerable:true,configurable:true});Object.defineProperty(MetroChart.prototype,"enableTimeAxis",{get:function(){return this._enableTimeAxis},set:function(enableTimeAxis){this._enableTimeAxis=enableTimeAxis},enumerable:true,configurable:true});Object.defineProperty(MetroChart.prototype,"charge",{get:function(){return this._charge},set:function(charge){this._charge=charge},enumerable:true,configurable:true});Object.defineProperty(MetroChart.prototype,"linkDistance",{get:function(){return this._linkDistance},set:function(linkDistance){this._linkDistance=linkDistance},enumerable:true,configurable:true});Object.defineProperty(MetroChart.prototype,"gravity",{get:function(){return this._gravity},set:function(gravity){this._gravity=gravity},enumerable:true,configurable:true});Object.defineProperty(MetroChart.prototype,"linkStrength",{get:function(){return this._linkStrength},set:function(linkStrength){this._linkStrength=linkStrength},enumerable:true,configurable:true});Object.defineProperty(MetroChart.prototype,"url",{get:function(){return this._url},enumerable:true,configurable:true});MetroChart.defaultOptions={charge:0,colors:[{name:"red",hexcode:"#FF0000"},{name:"olive",hexcode:"#008000"},{name:"blue",hexcode:"#0080FF"},{name:"orange",hexcode:"#FF8000"},{name:"magenta",hexcode:"#FF0080"},{name:"yellow",hexcode:"#FFee00"},{name:"lime",hexcode:"#80DD00"},{name:"purple",hexcode:"#b200ff"},{name:"seagreen",hexcode:"#00DD80"},{name:"dark gray",hexcode:"#888888"},{name:"black",hexcode:"#000000"}],enableTimeAxis:true,gravity:5e-4,labelSpaceVert:130,labelRotation:-45,padding:{left:50,right:50},linkDistance:1,linkStrength:0,stationShapeRadius:7};return MetroChart}();exports.MetroChart=MetroChart}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./metrocharterror":3}],3:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p];function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};var MetroChartError=function(_super){__extends(MetroChartError,_super);function MetroChartError(message){_super.call(this,message);this.name="MetroChartError";this.message=message}return MetroChartError}(Error);exports.MetroChartError=MetroChartError},{}]},{},[1])(1)});
//# sourceMappingURL=metrochart.min.js.map